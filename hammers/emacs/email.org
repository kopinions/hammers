#+TITLE:  mailbox 配置
#+AUTHOR: 孙建康（rising.lambda）
#+EMAIL:  rising.lambda@gmail.com

#+DESCRIPTION: mailbox 配置文件
#+PROPERTY:    header-args        :mkdirp yes
#+OPTIONS:     num:nil toc:nil todo:nil tasks:nil tags:nil
#+OPTIONS:     skip:nil author:nil email:nil creator:nil timestamp:nil
#+INFOJS_OPT:  view:nil toc:nil ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js


*** mail box 初始化
    #+NAME: database
    #+BEGIN_SRC shell :var database=(m/resolve "${m/home.d}/cloudfication/hammers/notmuch")
      mkdir -p ${database}
      echo ${database}
    #+END_SRC
    #+NAME: maildir
    #+BEGIN_SRC elisp :var maildir=(m/resolve "${m/home.d}/.mails")
      maildir
    #+END_SRC

    #+BEGIN_SRC shell :eval (or (and (eq m/os 'macos) "yes") "never") :exports none :results none :noweb yes
      mkdir -p <<maildir()>>/{ding,lambda,qq,sjkyspa}
    #+END_SRC

*** notmuch 配置
    #+BEGIN_SRC elisp :eval never :exports code :tangle (m/resolve "${m/conf.d}/lisp/init-email.el") :comments link
      (use-package notmuch
	:ensure-system-package (notmuch msmtp (mbsync . isync))
	:hook
	(notmuch-message-mode . turn-off-auto-fill)
	:bind (("C-x m" . sb/notmuch)
	       ("M-]" . notmuch-cycle-notmuch-buffers))
	:custom
	(notmuch-address-use-company nil)
	(notmuch-hello-thousands-separator ",")
	(notmuch-mua-cite-function (quote message-cite-original-without-signature))
	(notmuch-fcc-dirs "sent +sent -unread -inbox")
	(notmuch-saved-searches
	 (quote
	  ((:name "Inbox" :query "tag:inbox" :key "i")
	   (:name "Flagged" :query "tag:flagged" :key "f")
	   (:name "Drafts" :query "tag:draft" :key "d")
	   (:name "New in Threads" :query "thread:\"{from:stig}\" and tag:new and not tag:sent" :key "t" :sort-order newest-first :search-type tree)
	   (:name "All in Threads" :query "thread:\"{from:stig}\"" :key "T" :sort-order newest-first :search-type tree :count-query "tag:no-match")
	   (:name "List Messages" :query "tag:lists and tag:new and not tag:sent" :key "l" :search-type tree)
	   (:name "Recent-ish" :query "date:-4d..today and not tag:lists" :key "r" :count-query "tag:no-match" :sort-order newest-first))))
	(notmuch-tagging-keys
	 (quote
	  (("a" notmuch-archive-tags "Archive")
	   ("u" notmuch-show-mark-read-tags "Mark read")
	   ("f"
	    ("+flagged")
	    "Flag")
	   ("s"
	    ("+spam" "-inbox")
	    "Mark as spam")
	   ("d"
	    ("+deleted" "-inbox")
	    "Delete")
	   ("m"
	    ("+muted")
	    "Mute Thread"))))

	:config
	(defun sb/mbsync (&rest group)
	  (interactive)
	  (let ((group (or (and (car group) group) '("--all")))
		(command `("mbsync" "--verbose" "--quiet" ,@group)))
	    (message "Starting %s.." (mapconcat 'identity command " "))
	    (apply 'start-process "mbsync" "*mbsync*" command)))
	(defun sb/notmuch (arg)
	  "Launch notmuch. If ran with prefix arg, launch mbsync in the
	background, and automatically refresh the current buffer when
	done. With two prefix args, launch mbsync with `--all` rather
	than just for inboxes."
	  (interactive "p")
	  (notmuch)
	  (if (> arg 1)
	      (set-process-sentinel
	       (sb/mbsync (if (eq 4 arg) "inbox" "--all"))
	       (lambda (proc state)
		 (message nil) ;; clear minibuffer
		 (notmuch-poll-and-refresh-this-buffer))))))

    #+END_SRC

*** mbsync 配置（同步邮件）
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/home.d}/.mbsyncrc")
      IMAPAccount lambda
      Host imap.gmail.com
      User rising.lambda@gmail.com
      SSLType IMAPS
      AuthMechs PLAIN
      #PassCmd "security find-generic-password -s lambda -w"
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/.authinfo.gpg |grep rising.lambda@gmail.com|awk '{print $6}'"
      # To rotate:
      # > security delete-generic-password -s mbsync-gandi-password
      # > security add-generic-password -a stig@brautaset.org -s mbsync-gandi-password -w APP-SPECIFIC-PASSWORD

      IMAPStore lambda-remote
      Account lambda

      MaildirStore lambda-local
      SubFolders Verbatim
      Path ~/.mails/lambda/
      Inbox ~/.mails/lambda/INBOX

      Channel lambda-inbox
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns INBOX

      Channel lambda-starred
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Starred

      Channel lambda-snoozed
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Snoozed

      Channel lambda-sent
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Sent

      Channel lambda-spam
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Spam

      Channel lambda-drafts
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Drafts


      Channel lambda-trash
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Trash

      IMAPAccount ding
      Host imap.qiye.aliyun.com
      User neo@sietium.com
      SSLType IMAPS
      AuthMechs LOGIN
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/.authinfo.gpg | grep neo@sietium.com | awk '{print $6}'"
      #PassCmd "security find-generic-password -s lambda -w"

      # To rotate:
      # > security delete-generic-password -s mbsync-gandi-password
      # > security add-generic-password -a stig@brautaset.org -s mbsync-gandi-password -w APP-SPECIFIC-PASSWORD

      IMAPStore ding-remote
      Account ding

      MaildirStore ding-local
      SubFolders Verbatim
      Path ~/.mails/ding/
      Inbox ~/.mails/ding/INBOX

      Channel ding
      Far :ding-remote:
      Near :ding-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns INBOX Travel Archive Sent Spam Trash


      IMAPAccount qq
      Host imap.qq.com
      User sjkyspa@qq.com
      SSLType IMAPS
      SSLVersions TLSv1.2
      AuthMechs LOGIN
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/.authinfo.gpg | grep sjkyspa@qq.com | awk '{print $6}'"
      # To rotate:
      # > security delete-generic-password -s mbsync-gandi-password
      # > security add-generic-password -a stig@brautaset.org -s mbsync-gandi-password -w APP-SPECIFIC-PASSWORD

      IMAPStore qq-remote
      Account qq

      MaildirStore qq-local
      SubFolders Verbatim
      Path ~/.mails/qq/
      Inbox ~/.mails/qq/INBOX

      Channel qq
      Far :qq-remote:
      Near :qq-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns *
    #+END_SRC

*** notmuch 配置文件
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/home.d}/.notmuch-config") :noweb yes
      # 相对于 HOMEDIR ~ 的目录
      [database]
      path=<<database()>>
      mail_root=<<maildir()>>
      
      [user]
      name=neo
      primary_email=rising.lambda@gmail.com
      other_email=sjkyspa@gmail.com;neo@sietium.com;sjkyspa@qq.com

      [new]
      tags=new;
      ignore=.mbsyncstate;.mbsyncstate.journal;.mbsyncstate.lock;.mbsyncstate.new;.uidvalidity;.isyncuidmap.db

      [search]
      exclude_tags=deleted;spam;

      [maildir]
      synchronize_flags=true

    #+END_SRC

*** afew 配置文件
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/home.d}/.config/afew/config")
      # ~/.config/afew/config
      # 所有新邮件会从上至下经过所有规则

      # 邮件所在文件夹是什么名字，就打上什么 tag
      [FolderNameFilter]
      # 子文件夹分隔符： /
      # github/receipt 会被打上两个Tag： +github +receipt
      maildir_separator = /
      # 以下文件夹不加 tag
      folder_blacklist = Archive INBOX \[Gmail\] All\ Mail  
      # 所有文件夹名先转小写再打 Tag
      folder_lowercases = true

      # 被邮件服务器打上 Spam 标记的邮件： +junk
      [SpamFilter]
      spam_tag = 'junk'

      # 有一个极其活跃的讨论串，但内容我不感兴趣
      # 因此我给这个串 +killed
      # 接下来这个讨论串的新增讨论都会被自动 +killed
      [KillThreadsFilter]

      # 邮件 Headers 里的 List-Id： +lists/list-id
      # 对订阅的邮件列表极其有用
      # 比如 emacs-devel 邮件列表会被加上 lists/emacs-devel
      [ListMailsFilter]

      # 我自己已发送的邮件不打 tag
      [ArchiveSentMailsFilter]

      # To 给我的邮件： +to-me
      [MeFilter]

      # 在 INBOX 文件夹里： +inbox
      [InboxFilter]

      # 其他预置 filter 或自定义 filter：
      # https://afew.readthedocs.io/en/latest/filters.html

      # 同样的配置文件，把这段放在上一段后面即可

      [MailMover]
      # 要列出所有涉案的本地 maildir
      # 'lambda/Junk' 'lambda/Archive' 'lambda/Sent'
      folders = 'lambda/INBOX' 
      rename = True

      # xx 天之前的邮件不移动
      max_age = 3650

      # 规则：等号左边 dir 里的邮件，如果满足引号左边的搜索条件，则被移动到冒号右边的 dir
      # 注意：如果一个邮件同时符合多个搜索条件，它会被复制多份至所有符合条件的 maildir
      # 至于为什么，有过讨论：
      # https://github.com/afewmail/afew/issues/242
      # 这就是为什么这里写得这么死板
      # 当然你可以把它当作一个 feature 加以利用
      lambda/INBOX = 'tag:junk':'lambda/[Gmail]/Spam' 'NOT tag:inbox AND NOT tag:junk':'lambda/[Gmail]/All Mail' 'tag:inbox AND NOT tag:unread':'lambda/[Gmail]/All Mail'
    #+END_SRC
*** msmtp 配置（发送端）
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/home.d}/.msmtprc")
      # default config
      defaults
      port 587
      tls on
      tls_trust_file /etc/ssl/cert.pem
      auth on

      # config for the rising.lambda
      account lambda
      host smtp.gmail.com
      port 587
      tls on
      tls_starttls on
      auth on
      user rising.lambda@gmail.com
      from rising.lambda@gmail.com
      passwordeval "gpg --for-your-eyes-only --no-tty -qd ~/.authinfo.gpg |grep rising.lambda@gmail.com|awk '{print $6}'"

      account sietium
      host smtp.qiye.aliyun.com
      port 587
      tls on
      tls_starttls on
      auth on
      user neo@sietium.com
      from neo@sietium.com
      passwordeval "gpg --for-your-eyes-only --no-tty -qd ~/.authinfo.gpg | grep neo@sietium.com |awk '{print $6}'"

      account qq
      host smtp.qq.com
      port 587
      tls on
      tls_starttls on
      auth on
      user sjkyspa@qq.com
      from sjkyspa@qq.com
      passwordeval "gpg --for-your-eyes-only --no-tty -qd ~/.authinfo.gpg | grep sjkyspa@qq.com |awk '{print $6}'"
    #+END_SRC

*** emacs 发送端配置
    #+BEGIN_SRC elisp :eval never :exports code :tangle (m/resolve "${m/conf.d}/lisp/init-email.el") :comments link
      (setq message-send-mail-function 'message-send-mail-with-sendmail
	    sendmail-program "msmtp"
	    message-sendmail-envelope-from 'header
	    mail-envelope-from 'header
	    mail-specify-envelope-from t)

      (setq message-kill-buffer-on-exit t)
    #+END_SRC

    #+BEGIN_SRC elisp :eval never :exports code :tangle (m/resolve "${m/conf.d}/lisp/init-email.el") :comments link
      (provide 'init-email)
    #+END_SRC
