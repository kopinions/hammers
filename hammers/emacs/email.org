#+TITLE:  mailbox 配置
#+AUTHOR: 孙建康（rising.lambda）
#+EMAIL:  rising.lambda@gmail.com

#+DESCRIPTION: mailbox 配置文件
#+PROPERTY:    header-args        :mkdirp yes
#+OPTIONS:     num:nil toc:nil todo:nil tasks:nil tags:nil
#+OPTIONS:     skip:nil author:nil email:nil creator:nil timestamp:nil
#+INFOJS_OPT:  view:nil toc:nil ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js


*** mail box 初始化
    
    #+NAME: maildir
    #+BEGIN_SRC shell :var maildir=(m/resolve "${m/home.d}/mails")
      mkdir -p ${maildir}/{ding,lambda,qq,sjkyspa}
      echo ${maildir}
    #+END_SRC

*** notmuch 配置
    #+BEGIN_SRC elisp :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/emacs/lisp/init-email.el") :comments link
      (use-package notmuch
        :ensure-system-package (notmuch msmtp (mbsync . isync))
        :hook
        (notmuch-message-mode . turn-off-auto-fill)
        :bind (("C-x m" . sb/notmuch)
               ("M-]" . notmuch-cycle-notmuch-buffers))
        :custom
        (notmuch-address-use-company nil)
        (notmuch-hello-thousands-separator ",")
        (notmuch-mua-cite-function (quote message-cite-original-without-signature))
        (notmuch-fcc-dirs "sent +sent -unread -inbox")
        (notmuch-saved-searches
         (quote
          ((:name "Inbox" :query "tag:inbox" :key "i")
           (:name "Flagged" :query "tag:flagged" :key "f")
           (:name "Drafts" :query "tag:draft" :key "d")
           (:name "New in Threads" :query "thread:\"{from:stig}\" and tag:new and not tag:sent" :key "t" :sort-order newest-first :search-type tree)
           (:name "All in Threads" :query "thread:\"{from:stig}\"" :key "T" :sort-order newest-first :search-type tree :count-query "tag:no-match")
           (:name "List Messages" :query "tag:lists and tag:new and not tag:sent" :key "l" :search-type tree)
           (:name "Recent-ish" :query "date:-4d..today and not tag:lists" :key "r" :count-query "tag:no-match" :sort-order newest-first))))
        (notmuch-tagging-keys
         (quote
          (("a" notmuch-archive-tags "Archive")
           ("u" notmuch-show-mark-read-tags "Mark read")
           ("f"
            ("+flagged")
            "Flag")
           ("s"
            ("+spam" "-inbox")
            "Mark as spam")
           ("d"
            ("+deleted" "-inbox")
            "Delete")
           ("m"
            ("+muted")
            "Mute Thread"))))

        :config
        (defun sb/mbsync (&rest group)
          (interactive)
          (let ((group (or (and (car group) group) '("--all")))
                (command `("mbsync" "--verbose" "--quiet" ,@group)))
            (message "Starting %s.." (mapconcat 'identity command " "))
            (apply 'start-process "mbsync" "*mbsync*" command)))
        (defun sb/notmuch (arg)
          "Launch notmuch. If ran with prefix arg, launch mbsync in the
        background, and automatically refresh the current buffer when
        done. With two prefix args, launch mbsync with `--all` rather
        than just for inboxes."
          (interactive "p")
          (notmuch)
          (if (> arg 1)
              (set-process-sentinel
               (sb/mbsync (if (eq 4 arg) "inbox" "--all"))
               (lambda (proc state)
                 (message nil) ;; clear minibuffer
                 (notmuch-poll-and-refresh-this-buffer))))))

    #+END_SRC

*** mbsync 配置（同步邮件）
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/isync/config") :noweb yes
      IMAPAccount lambda
      Host imap.gmail.com
      User rising.lambda@gmail.com
      SSLType IMAPS
      AuthMechs PLAIN
      #PassCmd "security find-generic-password -s lambda -w"
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/credentials/authinfo.gpg |grep rising.lambda@gmail.com|awk '{print $6}'"
      # To rotate:
      # > security delete-generic-password -s mbsync-gandi-password
      # > security add-generic-password -a stig@brautaset.org -s mbsync-gandi-password -w APP-SPECIFIC-PASSWORD

      IMAPStore lambda-remote
      Account lambda

      MaildirStore lambda-local
      SubFolders Verbatim
      Path <<maildir()>>/lambda/
      Inbox <<maildir()>>/lambda/INBOX

      Channel lambda-inbox
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns INBOX

      Channel lambda-starred
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Starred

      Channel lambda-snoozed
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Snoozed

      Channel lambda-sent
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Sent

      Channel lambda-spam
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Spam

      Channel lambda-drafts
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Drafts


      Channel lambda-trash
      Far :lambda-remote:
      Near :lambda-local:
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns Trash

      IMAPAccount ding
      Host imap.qiye.aliyun.com
      User neo@sietium.com
      SSLType IMAPS
      AuthMechs LOGIN
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/credentials/authinfo.gpg | grep neo@sietium.com | awk '{print $6}'"
      #PassCmd "security find-generic-password -s lambda -w"

      # To rotate:
      # > security delete-generic-password -s mbsync-gandi-password
      # > security add-generic-password -a stig@brautaset.org -s mbsync-gandi-password -w APP-SPECIFIC-PASSWORD

      IMAPStore ding-remote
      Account ding

      MaildirStore ding-local
      SubFolders Verbatim
      Path <<maildir()>>/ding/
      Inbox <<maildir()>>/ding/INBOX

      Channel ding-inbox
      Far :ding-remote:INBOX
      Near :ding-local:INBOX
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-drafts
      Far :ding-remote:Drafts
      Near :ding-local:Drafts
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-trash
      Far :ding-remote:Trash
      Near :ding-local:Trash
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-sent
      Far :ding-remote:Sent
      Near :ding-local:Sent
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-spam
      Far :ding-remote:Spam
      Near :ding-local:Spam
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-archive
      Far :ding-remote:Archive
      Near :ding-local:Archive
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-gb2
      Far :ding-remote:GB2
      Near :ding-local:GB2
      Sync All
      Create Both
      Expunge Both
      SyncState *

      Channel ding-patent
      Far :ding-remote:Patent
      Near :ding-local:Patent
      Sync All
      Create Both
      Expunge Both
      SyncState *

      IMAPAccount qq
      Host imap.qq.com
      User sjkyspa@qq.com
      SSLType IMAPS
      SSLVersions TLSv1.2
      AuthMechs LOGIN
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/credentials/authinfo.gpg | grep sjkyspa@qq.com | awk '{print $6}'"
      # To rotate:
      # > security delete-generic-password -s mbsync-gandi-password
      # > security add-generic-password -a stig@brautaset.org -s mbsync-gandi-password -w APP-SPECIFIC-PASSWORD

      IMAPStore qq-remote
      Account qq

      MaildirStore qq-local
      SubFolders Verbatim
      Path <<maildir()>>/qq/
      Inbox <<maildir()>>/qq/INBOX

      Channel qq-inbox
      Far :qq-remote:"INBOX"
      Near :qq-local:"INBOX"
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns *

      Channel qq-drafts
      Far :qq-remote:"Drafts"
      Near :qq-local:"Drafts"
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns *

      Channel qq-spam
      Far :qq-remote:"Junk"
      Near :qq-local:"Spam"
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns *

      Channel qq-sent
      Far :qq-remote:"Sent Messages"
      Near :qq-local:"Sent"
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns *

      Channel qq-archive
      Far :qq-remote:"Archive"
      Near :qq-local:"Archive"
      Sync All
      Create Both
      Expunge Both
      SyncState *
      Patterns *
    #+END_SRC

*** mbsync pre-sync
    #+BEGIN_SRC shell :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/mbsync/hooks/pre-sync") :tangle-mode (identity #o755) :shebang #!/bin/bash :noweb yes :comments link
      # Move a message file while removing its UID-part
      function move { s=${1##*/}; s=${s%%,*}; mv -f $1 $2/$s; }

      echo moving $(notmuch count --output=files --exclude=false tag:gb2 AND folder:'ding/INBOX' AND NOT tag:unread) gb2 messages to the GB2
      for i in $(notmuch search --exclude=false --output=files tag:gb2 AND folder:'ding/INBOX' AND NOT tag:unread); do
          move $i "<<maildir()>>/ding/GB2/cur"
      done

      # Move all deleted messages to the Trash folder
      # echo moving $(notmuch count --output=files --exclude=false tag:deleted AND NOT folder:Trash) deleted messages to the Trash folder
      # for i in $(notmuch search --exclude=false --output=files tag:deleted AND NOT folder:Trash); do
      #     move $i "<<maildir()>>/ding/Trash/cur"
      # done

      # # Move all spam messages to the Spam folder
      # echo moving $(notmuch count --output=files tag:spam AND NOT folder:Spam) spam-marked messages to the Spam folder
      # for i in $(notmuch search --output=files tag:spam AND NOT folder:Spam); do
      #     move $i "<<maildir()>>/ding/Spam/cur"
      # done

      # # Move all archived messages from Inbox to Archive folder
      # echo Moving $(notmuch count --output=files folder:Inbox AND NOT tag:inbox) archived messages from Inbox to Archive folder
      # for i in $(notmuch search --output=files folder:Inbox AND NOT tag:inbox); do
      #     move $i "<<maildir()>>/ding/Archive/cur"
      # done

      # mbsync -a 

      # notmuch new --no-hooks
    #+END_SRC

*** notmuch 配置文件
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/notmuch/default/config") :noweb yes :comments link
      # 相对于 HOMEDIR ~ 的目录
      [database]
      path=<<maildir()>>

      [user]
      name=neo
      primary_email=rising.lambda@gmail.com
      other_email=sjkyspa@gmail.com;neo@sietium.com;sjkyspa@qq.com

      [new]
      tags=new;
      ignore=.mbsyncstate;.mbsyncstate.journal;.mbsyncstate.lock;.mbsyncstate.new;.uidvalidity;.isyncuidmap.db

      [search]
      exclude_tags=deleted;spam;

      [maildir]
      synchronize_flags=true

    #+END_SRC

*** notmuch hook
**** pre hook
     #+BEGIN_SRC shell :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/notmuch/default/hooks/pre-new") :tangle-mode (identity #o755) :shebang #!/bin/bash :noweb yes :comments link
       
     #+END_SRC

**** post hook
     #+BEGIN_SRC shell :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/notmuch/default/hooks/post-new") :tangle-mode (identity #o755) :shebang #!/bin/bash :noweb yes :comments link
       set -e 

       echo -n Filtering new messages
       ## All messages 

       ## Poor man's progress bar. adjust for number of steps 
       STEPS=30
       echo -n '   ['
       for n in `seq $STEPS`; do
           echo -n '.'
       done
       echo -ne ']\b'
       # Backspace
       for n in `seq $STEPS`; do
           echo -ne '\b'
       done

       ## notmuch post-processing script

       ## Generally only works with messages with the tag:new folder
       notmuch tag +inbox +unread -new -- tag:new
       # 需要处理下 send
       notmuch tag +gb2 -- to:'gb02*' and folder:'ding/INBOX'

       echo ']'
     #+END_SRC

**** post insert hook
     #+BEGIN_SRC shell :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/notmuch/default/hooks/post-insert") :tangle-mode (identity #o755) :shebang #!/bin/bash :noweb yes :comments link
       notmuch tag +watch -inbox -new tag:new 'folder:/.*Sent.*/'
     #+END_SRC
     
*** msmtp 配置（发送端）
    #+BEGIN_SRC conf :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/msmtp/config")
      # default config
      defaults
      port 587
      tls on
      tls_trust_file /etc/ssl/cert.pem
      auth on

      # config for the rising.lambda
      account lambda
      host smtp.gmail.com
      port 587
      tls on
      tls_starttls on
      auth on
      user rising.lambda@gmail.com
      from rising.lambda@gmail.com
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/credentials/authinfo.gpg |grep rising.lambda@gmail.com|awk '{print $6}'"

      account sietium
      host smtp.qiye.aliyun.com
      port 587
      tls on
      tls_starttls on
      auth on
      user neo@sietium.com
      from neo@sietium.com
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/credentials/authinfo.gpg | grep neo@sietium.com |awk '{print $6}'"

      account qq
      host smtp.qq.com
      port 587
      tls on
      tls_starttls on
      auth on
      user sjkyspa@qq.com
      from sjkyspa@qq.com
      PassCmd "gpg --for-your-eyes-only --no-tty -qd ~/credentials/authinfo.gpg | grep sjkyspa@qq.com |awk '{print $6}'"
    #+END_SRC

*** emacs 发送端配置
    #+BEGIN_SRC elisp :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/emacs/lisp/init-email.el") :comments link
      (setq message-send-mail-function 'message-send-mail-with-sendmail
            sendmail-program "msmtp"
            message-sendmail-envelope-from 'header
            mail-envelope-from 'header
            mail-specify-envelope-from t)

      (setq message-kill-buffer-on-exit t)
    #+END_SRC

    #+BEGIN_SRC elisp :eval never :exports code :tangle (m/resolve "${m/xdg.conf.d}/emacs/lisp/init-email.el") :comments link
      (provide 'init-email)
    #+END_SRC
